<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Простой голосовой чат</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fafafa;
        }
        video {
            width: 300px;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
<h1>Примитивный голосовой чат</h1>
<p>Открйте вторую вкладку и начните общение.</p>
<video id="localVideo" muted playsinline autoplay></video>
<video id="remoteVideo" playsinline autoplay></video>

<script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    // Начнем сразу получать разрешение на камеру/микрофон
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localVideo.srcObject = stream;

            // Инициализация RTC-соединения
            const connection = new RTCPeerConnection({
                iceServers: [{
                    urls: 'stun:stun.l.google.com:19302'
                }]
            });

            // Добавляем наши потоки в соединение
            connection.addStream(stream);

            // Обработчики кандидатов и новых потоков
            connection.onicecandidate = event => {
                if (event.candidate) {
                    console.log('Обнаружен ICE-кандидат:', event.candidate);
                }
            };

            connection.onaddstream = event => {
                remoteVideo.srcObject = event.stream;
            };

            // Генерируем и обрабатываем OFERTU
            connection.createOffer()
                .then(offer => {
                    connection.setLocalDescription(offer)
                        .then(() => {
                            // Сигнал должен быть передан вручную второму пользователю
                            console.log('Предоставьте следующее описание партнёру:');
                            console.log(connection.localDescription.sdp);
                        });
                });

            // Ожидаем получение OFFERTA от партнера
            window.onmessage = event => {
                const sdp = event.data;
                connection.setRemoteDescription(new RTCSessionDescription(sdp))
                    .then(() => {
                        connection.createAnswer()
                            .then(answer => {
                                connection.setLocalDescription(answer)
                                    .then(() => {
                                        console.log('Отправьте партнеру следующую ANSWER:');
                                        console.log(connection.localDescription.sdp);
                                    });
                            });
                    });
            };
        })
        .catch(error => {
            console.error('Ошибка доступа к устройству:', error);
        });
</script>
</body>
</html>