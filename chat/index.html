<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Простой голосовой чат</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fafafa;
        }
        video {
            width: calc(50% - 20px);
            height: auto;
            object-fit: cover;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
<!-- Локальное видео -->
<video id="localVideo" muted playsinline autoplay></video>
<!-- Удалённое видео -->
<video id="remoteVideo" playsinline autoplay></video>

<script>
    // Элемент для вывода ошибок
    const errorOutput = document.createElement('div');
    errorOutput.id = 'error-output';
    errorOutput.style.color = 'red';
    document.body.appendChild(errorOutput);

    // Подключение к локальной камере/микрофону
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(async stream => {
            const localVideo = document.getElementById('localVideo');
            localVideo.srcObject = stream;

            // Создаем объект WebRTC соединения
            const connection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });

            // Добавляем наш поток в соединение
            connection.addStream(stream);

            // Прием удаленного потока
            connection.onaddstream = event => {
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = event.stream;
            };

            // Обмен ICE-кандидатами
            connection.onicecandidate = event => {
                if (event.candidate) {
                    console.log('ICE Candidate:', event.candidate);
                }
            };

            // Генерируем предложение (Offer)
            const offer = await connection.createOffer();
            await connection.setLocalDescription(offer);

            // Предложенное описание выводим в консоль для ручного обмена
            console.log('Предложите это описание другому участнику:', connection.localDescription.sdp);

            // Ждем прихода Answer от другого участника
            window.onmessage = event => {
                const answerSdp = event.data;
                connection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answerSdp }));
            };

            // Ожидание Offer от второго участника
            const secondOffer = prompt('Вставьте предложение от другого участника:');
            connection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: secondOffer }))
                .then(() => {
                    connection.createAnswer()
                        .then(answer => {
                            connection.setLocalDescription(answer)
                                .then(() => {
                                    console.log('Отправьте этому предложению ответ:', connection.localDescription.sdp);
                                });
                        });
                });
        })
        .catch(error => {
            errorOutput.textContent = `Ошибка доступа к устройствам: ${error}`;
        });
</script>
</body>
</html>
