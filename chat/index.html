<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Простой голосовой чат</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fafafa;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        p.instruction {
            font-weight: bold;
            color: #4a4a4a;
            margin-bottom: 10px;
        }
        form {
            display: inline-block;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        video {
            width: 300px;
            height: auto;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Простой голосовой чат</h1>
    <p class="instruction">Шаг 1: Откройте эту страницу в другом окне браузера.</p>
    <p class="instruction">Шаг 2: Дождитесь появления формы ниже и выполните инструкции.</p>

    <form id="setupForm" hidden>
        <label for="offerInput">Вставьте предложение от другого пользователя:</label>
        <input type="text" id="offerInput" required />
        <button type="submit">Продолжить</button>
    </form>

    <p id="offerMessage" hidden>Ваше предложение:</p>
    <textarea id="offerArea" rows="4" cols="50" readonly hidden></textarea>
    <button id="copyOfferBtn" hidden>Скопировать предложение</button>

    <p id="waitingMsg" hidden>Ожидайте... Устанавливаю соединение.</p>

    <!-- Локальное видео -->
    <video id="localVideo" muted playsinline autoplay></video>
    <!-- Удалённое видео -->
    <video id="remoteVideo" playsinline autoplay></video>

    <script>
        // Доступ к камере/микрофону
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(async stream => {
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;

                // Создаем объект WebRTC соединения
                const connection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                });

                // Добавляем наш поток в соединение
                connection.addStream(stream);

                // Прием удалённого потока
                connection.onaddstream = event => {
                    const remoteVideo = document.getElementById('remoteVideo');
                    remoteVideo.srcObject = event.stream;
                };

                // Обмен ICE-кандидатами
                connection.onicecandidate = event => {
                    if (event.candidate) {
                        console.log('ICE Candidate:', event.candidate);
                    }
                };

                // Форма для вставки оффера
                const setupForm = document.getElementById('setupForm');
                setupForm.addEventListener('submit', async event => {
                    event.preventDefault();
                    const offerInput = document.getElementById('offerInput');
                    const offerSdp = offerInput.value;
                    const offer = new RTCSessionDescription({ type: 'offer', sdp: offerSdp });
                    await connection.setRemoteDescription(offer);

                    // Генерируем ответ (Answer)
                    const answer = await connection.createAnswer();
                    await connection.setLocalDescription(answer);

                    // Показываем наше предложение для отправки второму пользователю
                    const offerArea = document.getElementById('offerArea');
                    offerArea.value = answer.sdp;
                    offerArea.hidden = false;
                    document.getElementById('offerMessage').hidden = false;
                    document.getElementById('copyOfferBtn').hidden = false;
                    document.getElementById('waitingMsg').hidden = false;

                    // Скрытие формы
                    setupForm.hidden = true;
                });

                // Генерируем первоначальное предложение (Offer)
                const offer = await connection.createOffer();
                await connection.setLocalDescription(offer);

                // Покажем форму для ввода оффера от второго пользователя
                setupForm.hidden = false;
            })
            .catch(error => {
                console.error('Ошибка доступа к устройству:', error);
            });

        // Функционал копирования оффера
        document.getElementById('copyOfferBtn').onclick = () => {
            const offerArea = document.getElementById('offerArea');
            offerArea.select();
            document.execCommand('copy');
            alert('Предложение успешно скопировано!');
        };
    </script>
</body>
</html>
